/*!
 * Facade.js (facadejs.com)
 * Copyright (c) 2013 Scott Doxey
 * Dual-licensed under both MIT and BSD licenses.
 */

(function(){"use strict";var t,i,e=document.createElement("canvas").getContext("2d");["webkit","moz"].forEach(function(e){t=t||window.requestAnimationFrame||window[e+"RequestAnimationFrame"]||null;i=i||window.cancelAnimationFrame||window[e+"CancelAnimationFrame"]||null});function s(t){return Object.prototype.toString.call(t)==="[object Array]"?true:false}function n(t,i,e){if(!(this instanceof n)){return new n(t,i,e)}if(t&&typeof t==="object"&&t.nodeType===1){this.canvas=t}else{this.canvas=document.createElement("canvas");if(typeof t==="string"){this.canvas.setAttribute("id",t)}}if(i&&e){this.canvas.setAttribute("width",parseInt(i,10));this.canvas.setAttribute("height",parseInt(e,10))}try{this.context=this.canvas.getContext("2d")}catch(s){throw new Error("Parameter passed to Facade.js is not a valid canvas element")}this.dt=0;this.fps=0;this.ftime=null;this._callback=null;this._requestAnimation=null}n.prototype.addToStage=function(t,i){var e;if(!(t instanceof n.Entity)){throw new Error("Parameter passed to Facade.addToStage is not a valid Facade.js entity object")}if(i){i=t.setOptions(i,true);e=t._setMetrics(i,true)}else{i=t.getAllOptions();e=t.getAllMetrics()}if(t.isVisible(this,e)){this.context.save();t._draw.call(t,this,i,e);this.context.restore()}return this};n.prototype._animate=function(i){if(typeof this._callback==="function"){if(this.ftime){this.dt=i-this.ftime;this.fps=(1e3/this.dt).toFixed(2)}this._requestAnimation=t(this._animate.bind(this));this.ftime=i;this.context.save();this._callback.call(this);this.context.restore()}else{this.stop()}return this};n.prototype.clear=function(){this.context.clearRect(0,0,this.width(),this.height());return this};n.prototype.draw=function(t){if(typeof t==="function"){this._callback=t;this.start()}else{throw new Error("Parameter passed to Facade.draw is not a valid function")}return this};n.prototype.exportBase64=function(t,i){if(!t){t="image/png"}if(typeof i==="number"){i=i/100}else{i=1}return this.canvas.toDataURL(t,i)};n.prototype.height=function(t){if(t){this.canvas.setAttribute("height",parseInt(t,10))}return this.canvas.height};n.prototype.start=function(){this._requestAnimation=t(this._animate.bind(this));return this};n.prototype.stop=function(){this.dt=0;this.fps=0;this.ftime=null;this._requestAnimation=i(this._requestAnimation);return this};n.prototype.width=function(t){if(t){this.canvas.setAttribute("width",parseInt(t,10))}return this.canvas.width};n.Entity=function(){};n.Entity.prototype._defaultOptions=function(){return{x:0,y:0,shadowBlur:0,shadowColor:"#000",shadowOffsetX:0,shadowOffsetY:0,anchor:"top/left",opacity:100,flip:"",rotate:0,scale:1}};n.Entity.prototype._defaultMetrics=function(){return{x:null,y:null,width:null,height:null}};n.Entity.prototype._setContext=function(t,i,e){var s=this._getRotatePoint(i,e),n=i.flip.match(/horizontal/),o=i.flip.match(/vertical/);t.translate(e.x,e.y);if(i.rotate){t.translate(s[0],s[1]);t.rotate(i.rotate*Math.PI/180);t.translate(-s[0],-s[1])}if(n){t.translate(e.width,0)}if(o){t.translate(0,e.height)}t.scale(i.scale,i.scale);if(n){t.scale(-1,1)}if(o){t.scale(1,-1)}t.globalAlpha=i.opacity/100;if(i.fillStyle){t.fillStyle=i.fillStyle}if(i.lineCap){t.lineCap=i.lineCap}if(i.lineWidth){t.lineWidth=i.lineWidth;t.strokeStyle=i.strokeStyle}if(i.shadowBlur){t.shadowBlur=i.shadowBlur;t.shadowColor=i.shadowColor;t.shadowOffsetX=i.shadowOffsetX;t.shadowOffsetY=i.shadowOffsetY}if(i.fontStyle){t.font=i.fontStyle+" "+i.fontSize+"px "+i.fontFamily;t.textBaseline=i.textBaseline}};n.Entity.prototype.getOption=function(t){if(this._options.hasOwnProperty(t)){return this._options[t]}return undefined};n.Entity.prototype.getAllOptions=function(){var t={},i;for(i in this._options){if(this._options.hasOwnProperty(i)){t[i]=this._options[i]}}return t};n.Entity.prototype.setOptions=function(t,i){var e=this.getAllOptions(),s;for(s in t){if(t.hasOwnProperty(s)&&e.hasOwnProperty(s)){if(String(typeof this._options[s])===String(typeof t[s])){e[s]=t[s];if(i!==true){this._options[s]=t[s]}}else{throw new Error("The value for "+s+" was a "+typeof t[s]+" not a "+typeof this._options[s])}}}if(i!==true){this._setMetrics(e,i)}return e};n.Entity.prototype.getMetric=function(t){if(this._metrics.hasOwnProperty(t)){return this._metrics[t]}return undefined};n.Entity.prototype.getAllMetrics=function(){var t={},i;for(i in this._metrics){if(this._metrics.hasOwnProperty(i)){t[i]=this._metrics[i]}}return t};n.Entity.prototype.isVisible=function(t,i){if(t instanceof n){t=t.canvas}if(t&&typeof t==="object"&&t.nodeType===1){if(String(typeof i)==="undefined"){i=this._metrics}if(i.x<t.width&&i.x+i.width>0&&i.y<t.height&&i.y+i.height>0){return true}}else{throw new Error("Parameter passed to Facade.Entity.isVisible is not a valid canvas element")}return false};n.Entity.prototype._getAnchorPoint=function(t,i){var e=t.x,s=t.y;if(t.anchor.match(/^center/)){s=t.y-i.height/2}else if(t.anchor.match(/^bottom/)){s=t.y-i.height}if(t.anchor.match(/center$/)){e=t.x-i.width/2}else if(t.anchor.match(/right$/)){e=t.x-i.width}return[e,s]};n.Entity.prototype._getRotatePoint=function(t,i){var e=0,s=0;if(t.anchor.match(/^center/)){s=i.height/2}else if(t.anchor.match(/^bottom/)){s=i.height}if(t.anchor.match(/center$/)){e=i.width/2}else if(t.anchor.match(/right$/)){e=i.width}return[e,s]};n.Circle=function(t){if(!(this instanceof n.Circle)){return new n.Circle(t)}this._options=this._defaultOptions();this._metrics=this._defaultMetrics();this._options.radius=10;this._options.start=0;this._options.end=360;this._options.counterclockwise=false;this._options.fillStyle="#000";this._options.strokeStyle="#000";this._options.strokePosition="default";this._options.lineWidth=0;this._options.lineCap="butt";this.setOptions(t)};n.Circle.prototype=Object.create(n.Entity.prototype);n.Circle.prototype._draw=function(t,i,e){var s=t.context,n=0;this._setContext(s,i,e);s.beginPath();s.arc(0,0,i.radius,i.start*Math.PI/180,i.end*Math.PI/180,i.counterclockwise);if(i.fillStyle){s.fill()}if(i.strokePosition.match(/(in|out)set/)){if(i.strokePosition==="inset"){n=-(i.lineWidth/2)}else if(i.strokePosition==="outset"){n=i.lineWidth/2}s.closePath();s.beginPath();s.arc(0,0,i.radius+n,i.start*Math.PI/180,i.end*Math.PI/180,i.counterclockwise)}if(i.lineWidth){s.stroke()}s.closePath()};n.Circle.prototype._setMetrics=function(t,i){var e=this.getAllMetrics(),s,n=0;if(t.strokePosition==="default"){n=t.lineWidth/2}else if(t.strokePosition==="outset"){n=t.lineWidth}e.width=(t.radius+n)*2*t.scale;e.height=(t.radius+n)*2*t.scale;s=this._getAnchorPoint(t,e);e.x=s[0]+(t.radius+n)*t.scale;e.y=s[1]+(t.radius+n)*t.scale;if(i!==true){this._metrics=e}return e};n.Image=function(t,i){if(String(typeof t)==="undefined"){throw new Error('Required parameter "source" missing from Facade.Image call')}if(!(this instanceof n.Image)){return new n.Image(t,i)}this._options=this._defaultOptions();this._metrics=this._defaultMetrics();this._options.width=0;this._options.height=0;this._options.offsetX=0;this._options.offsetY=0;this._options.tileX=1;this._options.tileY=1;this._options.frames=[];this._options.speed=120;this._options.loop=true;this._options.callback=function(t){};this.image=this.load(t);this.currentFrame=0;this.isAnimating=false;this.setOptions(i)};n.Image.prototype=Object.create(n.Entity.prototype);n.Image.prototype.play=function(){this.isAnimating=true;return this};n.Image.prototype.pause=function(){this.isAnimating=false;return this};n.Image.prototype.reset=function(){this.currentFrame=0;return this};n.Image.prototype.stop=function(){this.currentFrame=0;this.isAnimating=false;return this};n.Image.prototype.load=function(t){var i;if(typeof t==="object"&&t.nodeType===1){i=t;if(i.complete){this._setMetrics.call(this,this._options)}else{i.addEventListener("load",this._setMetrics.bind(this,this._options))}}else{i=document.createElement("img");i.setAttribute("src",t);i.addEventListener("load",this._setMetrics.bind(this,this._options))}return i};n.Image.prototype._draw=function(t,i,e){var s=t.context,n=0,o=0,r=0;if(this.image.complete){this._setContext(s,i,e);if(i.frames.length){n=i.frames[this.currentFrame]||0}for(o=0;o<i.tileX;o+=1){for(r=0;r<i.tileY;r+=1){s.drawImage(this.image,i.width*n+i.offsetX,i.offsetY,i.width,i.height,i.width*o,i.height*r,i.width,i.height)}}if(this.isAnimating&&i.frames.length){if(!this.ftime){this.ftime=t.ftime;if(typeof i.callback==="function"){i.callback.call(this,i.frames[this.currentFrame])}}if(t.ftime-this.ftime>=i.speed){this.ftime=t.ftime;this.currentFrame+=1;if(this.currentFrame>=i.frames.length){if(i.loop){this.currentFrame=0}else{this.currentFrame=i.frames.length-1;this.isAnimating=false}}if(typeof i.callback==="function"){i.callback.call(this,i.frames[this.currentFrame])}}}}};n.Image.prototype._setMetrics=function(t,i){var e=this.getAllMetrics(),s;if(this.image.complete){t.width=t.width||this.image.width;t.height=t.height||this.image.height;e.width=t.width*t.tileX*t.scale;e.height=t.height*t.tileY*t.scale;s=this._getAnchorPoint(t,e);e.x=s[0];e.y=s[1];if(i!==true){this._metrics=e}return e}};n.Line=function(t){if(!(this instanceof n.Line)){return new n.Line(t)}this._options=this._defaultOptions();this._metrics=this._defaultMetrics();this._options.startX=0;this._options.startY=0;this._options.endX=0;this._options.endY=0;this._options.strokeStyle="#000";this._options.lineWidth=1;this._options.lineCap="butt";this.setOptions(t)};n.Line.prototype=Object.create(n.Entity.prototype);n.Line.prototype._draw=function(t,i,e){var s=t.context;if(i.lineWidth){this._setContext(s,i,e);s.beginPath();s.moveTo(0,0);s.lineTo(i.endX-i.startX,i.endY-i.startY);s.stroke();s.closePath()}};n.Line.prototype._setMetrics=function(t,i){var e=this.getAllMetrics(),s;e.width=Math.abs(t.endX-t.startX)*t.scale;e.height=Math.abs(t.endY-t.startY)*t.scale;s=this._getAnchorPoint(t,e);e.x=s[0];e.y=s[1];if(i!==true){this._metrics=e}return e};n.Rect=function(t){if(!(this instanceof n.Rect)){return new n.Rect(t)}this._options=this._defaultOptions();this._metrics=this._defaultMetrics();this._options.width=100;this._options.height=100;this._options.fillStyle="#000";this._options.strokeStyle="#000";this._options.strokePosition="default";this._options.lineWidth=0;this._options.borderRadius=0;this.setOptions(t)};n.Rect.prototype=Object.create(n.Entity.prototype);n.Rect.prototype._draw=function(t,i,e){var s=t.context,n;this._setContext(s,i,e);s.beginPath();if(i.borderRadius){n=Math.min(i.borderRadius,i.height/2,i.width/2);s.moveTo(n,0);s.arc(i.width-n,n,n,Math.PI*1.5,0);s.arc(i.width-n,i.height-n,n,0,Math.PI*.5);s.arc(n,i.height-n,n,Math.PI*.5,Math.PI);s.arc(n,n,n,Math.PI,Math.PI*1.5);if(i.fillStyle){s.fill()}if(i.lineWidth){s.stroke()}}else{if(i.fillStyle){s.fillRect(0,0,i.width,i.height)}if(i.lineWidth){if(i.strokePosition==="inset"){s.strokeRect(i.lineWidth/2,i.lineWidth/2,i.width-i.lineWidth,i.height-i.lineWidth)}else if(i.strokePosition==="outset"){s.strokeRect(-i.lineWidth/2,-i.lineWidth/2,i.width+i.lineWidth,i.height+i.lineWidth)}else{s.strokeRect(0,0,i.width,i.height)}}}s.closePath()};n.Rect.prototype._setMetrics=function(t,i){var e=this.getAllMetrics(),s,n=0;if(t.strokePosition==="default"){n=t.lineWidth/2}else if(t.strokePosition==="outset"){n=t.lineWidth}e.width=(t.width+n*2)*t.scale;e.height=(t.height+n*2)*t.scale;s=this._getAnchorPoint(t,e);e.x=s[0]+n*t.scale;e.y=s[1]+n*t.scale;if(i!==true){this._metrics=e}return e};n.Text=function(t){if(!(this instanceof n.Text)){return new n.Text(t)}this._options=this._defaultOptions();this._metrics=this._defaultMetrics();this._options.width=0;this._options.value="";this._options.fontFamily="Arial";this._options.fontSize=30;this._options.fontStyle="normal";this._options.lineHeight=0;this._options.textAlign="left";this._options.textBaseline="top";this._options.fillStyle="#000";this._options.strokeStyle="#000";this._options.lineWidth=0;this.setOptions(t)};n.Text.prototype=Object.create(n.Entity.prototype);n.Text.prototype._draw=function(t,i,e){var n=t.context,o=0,r,h;this._setContext(n,i,e);if(!s(i.value)){i.value=i.value.split(/[ ]*\n[ ]*/)}if(!i.lineHeight){i.lineHeight=i.fontSize}for(r=0,h=i.value.length;r<h;r+=1){if(i.textAlign==="center"){o=(i.width-n.measureText(i.value[r]).width)/2}else if(i.textAlign==="right"){o=i.width-n.measureText(i.value[r]).width}if(i.fillStyle){n.fillText(i.value[r],o,r*i.lineHeight)}if(i.lineWidth){n.strokeText(i.value[r],o,r*i.lineHeight)}}};n.Text.prototype._setMetrics=function(t,i){var n=this.getAllMetrics(),o,r,h;e.font=t.fontStyle+" "+t.fontSize+"px "+t.fontFamily;if(!s(t.value)){t.value=t.value.split(/[ ]*\n[ ]*/)}if(!t.lineHeight){t.lineHeight=t.fontSize}for(r=0,h=t.value.length;r<h;r+=1){t.width=Math.max(t.width,e.measureText(t.value[r]).width)}n.width=t.width*t.scale;n.height=h*t.lineHeight*t.scale;o=this._getAnchorPoint(t,n);n.x=o[0];n.y=o[1];if(i!==true){this._metrics=n}return n};if(typeof window.define==="function"&&window.define.hasOwnProperty("amd")){window.define([],function(){return n})}else{window.Facade=n}})();